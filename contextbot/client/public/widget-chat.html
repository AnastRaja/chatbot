<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <!-- Use Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Modern Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Smooth fade in for messages */
        .message-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Markdown Styles for bot responses */
        .markdown-body {
            /* Inherit font sizes and line heights from parent */
            color: inherit;
        }

        .markdown-body p {
            margin-bottom: 0.75em;
        }

        .markdown-body p:last-child {
            margin-bottom: 0;
        }

        .markdown-body strong {
            font-weight: 600;
            color: #111827;
            /* Darker tone for emphasis */
        }

        .markdown-body ul,
        .markdown-body ol {
            margin-top: 0.5em;
            margin-bottom: 0.75em;
            padding-left: 1.5em;
        }

        .markdown-body ul {
            list-style-type: disc;
        }

        .markdown-body ol {
            list-style-type: decimal;
        }

        .markdown-body li {
            margin-bottom: 0.25em;
        }

        .markdown-body a {
            color: #2563eb;
            text-decoration: underline;
        }

        .markdown-body a:hover {
            text-decoration: none;
        }
    </style>
</head>

<body class="bg-white flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <div id="header"
        class="p-4 sm:p-5 bg-blue-600 text-white shadow-lg z-10 flex items-center justify-between border-b border-white/10 shrink-0">
        <div class="flex items-center gap-3">
            <div id="header-avatar-container" class="hidden">
                <img id="header-avatar" src="" alt="Agent Avatar"
                    class="w-10 h-10 rounded-full object-cover border-2 border-white/20 shadow-sm" />
            </div>
            <div class="flex flex-col">
                <h1 class="font-semibold text-lg sm:text-xl tracking-tight leading-tight">Support Chat</h1>
                <p class="text-[13px] text-white/90 mt-0.5 leading-tight flex items-center gap-1.5"><span
                        class="inline-block w-2 h-2 bg-emerald-400 rounded-full"></span> Online</p>
            </div>
        </div>
        <div class="flex items-center gap-1">
            <button type="button"
                class="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors active:scale-95 group"
                title="Options">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="19" cy="12" r="1"></circle>
                    <circle cx="5" cy="12" r="1"></circle>
                </svg>
            </button>
            <button type="button" onclick="window.parent.postMessage({ type: 'CLOSE_WIDGET' }, '*')"
                class="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors active:scale-95 group"
                title="Close chat">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round"
                    class="group-hover:rotate-90 transition-transform duration-200">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
    </div>

    <!-- Message List -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-4 bg-gray-50">
        <!-- Initial Greeting -->
        <div class="flex justify-start message-enter">
            <div
                class="bg-white border text-gray-800 p-4 rounded-2xl rounded-tl-none shadow-sm max-w-[85%] text-[15px] leading-relaxed">
                Hello! üëã We're here to help. Ask us anything about our services.
            </div>
        </div>
    </div>

    <!-- Quick Questions Container -->
    <div id="quick-questions" class="px-5 pb-3 bg-gray-50 flex-wrap gap-2 hidden">
    </div>

    <!-- Input Area -->
    <div class="p-4 bg-white border-t border-gray-100">
        <form id="chat-form" class="flex gap-3 items-center">
            <input type="text" id="user-input"
                class="flex-1 bg-gray-50 border border-gray-200 rounded-full px-5 py-3 text-[15px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500/20 transition-all placeholder-gray-400 shadow-sm"
                placeholder="Type your message..." autocomplete="off">
            <button type="submit"
                class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition-all shadow-md hover:shadow-lg active:scale-95 flex-shrink-0">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </form>
        <div class="text-center mt-3 mb-1">
            <a href="https://leadvox.in" target="_blank" rel="noopener noreferrer"
                class="text-[11px] text-gray-400 hover:text-gray-600 transition-colors inline-flex items-center gap-1 font-medium">
                ‚ö° Powered by leadvox.in
            </a>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const bizId = params.get('bizId');
        const color = params.get('color') || '#2563eb';
        const agentName = params.get('agentName') || 'Support Chat';
        const welcomeMsg = params.get('welcome') || "Hello! \uD83D\uDC4B We're here to help. Ask us anything about our services.";
        const avatarUrl = params.get('avatar');

        // Styling Updates
        document.getElementById('header').style.backgroundColor = color;
        document.querySelector('button[type="submit"]').style.backgroundColor = color;

        // Dynamic Content
        const headerTitle = document.querySelector('#header h1');
        headerTitle.textContent = agentName;

        if (avatarUrl && avatarUrl.trim() !== '' && avatarUrl !== 'null' && avatarUrl !== 'undefined') {
            document.getElementById('header-avatar-container').classList.remove('hidden');
            document.getElementById('header-avatar').src = avatarUrl;
        }

        const initialMsg = document.querySelector('#chat-messages div > div');
        if (initialMsg) initialMsg.textContent = welcomeMsg;

        const chatContainer = document.getElementById('chat-messages');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('user-input');

        // Session ID storage
        let chatId = sessionStorage.getItem('contextbot_chat_id');
        let pageContext = null;
        let ws = null;

        function connectWebSocket(id) {
            if (ws || !id) return;
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Use the same host where the widget was loaded from, with expected query params
            ws = new WebSocket(`${protocol}//${window.location.host}/socket?type=widget&chatId=${id}`);

            ws.onopen = () => {
                // Connected
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    // Match the structure from the server's sendToWidget
                    // It uses JSON.stringify({ type: eventType, payload })
                    if (data.type === 'NEW_MESSAGE' && data.payload) {
                        const msg = data.payload;
                        if (msg.sender === 'bot' || msg.sender === 'agent') {
                            // Remove loading indicator if it exists
                            const loadingIds = document.querySelectorAll('[id^="loading-"]');
                            loadingIds.forEach(el => el.remove());
                            appendMessage(msg.content, 'bot'); // Display agent message
                        }
                    } else if (data.type === 'CHAT_ENDED') {
                        // Show chat ended notification in the chat window
                        const endMsg = (data.payload && data.payload.message)
                            ? data.payload.message
                            : 'This chat session has ended. Thank you for reaching out!';
                        appendSystemMessage(endMsg);

                        // Hide input form and show "Chat ended" notice
                        const inputArea = document.querySelector('#chat-form').closest('div');
                        if (inputArea) inputArea.style.display = 'none';

                        const endedNotice = document.createElement('div');
                        endedNotice.className = 'p-4 bg-gray-100 border-t border-gray-200 text-center text-gray-500 text-sm';
                        endedNotice.textContent = '‚úÖ Chat has ended';
                        document.body.appendChild(endedNotice);

                        // Clear session storage so a fresh chat can start on reload
                        sessionStorage.removeItem('contextbot_chat_id');
                    }
                } catch (e) {
                    // Silently fail parsing
                }
            };

            ws.onclose = () => {
                ws = null;
                // Try to reconnect
                setTimeout(() => connectWebSocket(id), 5000);
            };
        }

        if (chatId) {
            connectWebSocket(chatId);
        }

        // Listen for context from parent widget.js
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'PAGE_CONTEXT') {
                pageContext = event.data;

                // Check for avatar update gracefully if it changed somehow
                if (pageContext.agentAvatar && pageContext.agentAvatar.trim() !== '') {
                    document.getElementById('header-avatar-container').classList.remove('hidden');
                    document.getElementById('header-avatar').src = pageContext.agentAvatar;
                }

                // Render Quick Questions
                if (event.data.quickQuestions && event.data.quickQuestions.length > 0 && !window.qsRendered) {
                    window.qsRendered = true;
                    const qqContainer = document.getElementById('quick-questions');
                    qqContainer.classList.remove('hidden');
                    qqContainer.classList.add('flex');

                    event.data.quickQuestions.forEach(q => {
                        const pill = document.createElement('button');
                        pill.className = "text-left px-4 py-2 bg-white border border-gray-200 rounded-2xl text-[13px] font-medium transition-colors shadow-sm cursor-pointer hover:bg-gray-100";
                        pill.style.color = color;
                        pill.style.borderColor = color;
                        pill.textContent = q.question;
                        pill.onclick = () => {
                            input.value = q.question;
                            form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                            qqContainer.style.display = 'none'; // Hide after use
                        };
                        qqContainer.appendChild(pill);
                    });
                }
            }
        });

        function appendSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'flex justify-center message-enter';
            const bubble = document.createElement('div');
            bubble.className = 'bg-amber-50 border border-amber-200 text-amber-800 rounded-xl px-4 py-2 text-[13px] text-center max-w-[90%] font-medium';
            bubble.textContent = text;
            div.appendChild(bubble);
            chatContainer.appendChild(div);
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} message-enter`;

            const bubble = document.createElement('div');
            const userClasses = 'bg-blue-600 text-white rounded-2xl rounded-tr-none';
            const botClasses = 'bg-white border text-gray-800 rounded-2xl rounded-tl-none shadow-sm';

            bubble.className = `p-4 max-w-[85%] text-[15px] leading-relaxed ${sender === 'user' ? userClasses : botClasses}`;
            if (sender === 'user') {
                bubble.style.backgroundColor = color;
                // Safely insert user text to prevent XSS
                bubble.textContent = text;
            } else {
                // Parse AI markdown and inject
                bubble.classList.add('markdown-body');
                bubble.innerHTML = marked.parse(text);
            }

            div.appendChild(bubble);
            chatContainer.appendChild(div);
            // Smooth scroll
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        async function sendMessage(message) {
            appendMessage(message, 'user');
            input.value = '';
            input.disabled = true;

            // Loading indicator
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex justify-start message-enter';
            loadingDiv.innerHTML = '<div class="bg-gray-100 p-3 rounded-2xl rounded-tl-none text-xs text-gray-500 flex items-center gap-1"><span class="animate-bounce">‚óè</span><span class="animate-bounce delay-100">‚óè</span><span class="animate-bounce delay-200">‚óè</span></div>';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch(`${window.location.origin}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bizId,
                        message,
                        chatId,
                        pageContext // Send captured context
                    })
                });

                const data = await response.json();

                if (data.chatId) {
                    if (!chatId) {
                        chatId = data.chatId;
                        sessionStorage.setItem('contextbot_chat_id', chatId);
                        connectWebSocket(chatId);
                    }
                }

                // Remove loading indicator
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();

                if (data.response) {
                    appendMessage(data.response, 'bot');
                } else if (!data.isAgentActive) {
                    appendMessage('Sorry, I encountered an error.', 'bot');
                }

            } catch (error) {
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();
                appendMessage('Error connecting to server.', 'bot');
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if (text && bizId) sendMessage(text);
        });
    </script>
</body>

</html>