<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <!-- Use Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Modern Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Smooth fade in for messages */
        .message-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-white flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <div id="header" class="p-5 bg-blue-600 text-white shadow-lg z-10 flex border-b border-white/10">
        <div class="flex flex-col">
            <h1 class="font-semibold text-xl tracking-tight">Support Chat</h1>
            <p class="text-sm text-white/80 mt-0.5">We typically reply in a few minutes</p>
        </div>
    </div>

    <!-- Message List -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-4 bg-gray-50">
        <!-- Initial Greeting -->
        <div class="flex justify-start message-enter">
            <div
                class="bg-white border text-gray-800 p-4 rounded-2xl rounded-tl-none shadow-sm max-w-[85%] text-[15px] leading-relaxed">
                Hello! üëã We're here to help. Ask us anything about our services.
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="p-4 bg-white border-t border-gray-100">
        <form id="chat-form" class="flex gap-3 items-center">
            <input type="text" id="user-input"
                class="flex-1 bg-gray-50 border border-gray-200 rounded-full px-5 py-3 text-[15px] focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500/20 transition-all placeholder-gray-400 shadow-sm"
                placeholder="Type your message..." autocomplete="off">
            <button type="submit"
                class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition-all shadow-md hover:shadow-lg active:scale-95 flex-shrink-0">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </form>
    </div>

    <script>
        // Parse Query Params
        const params = new URLSearchParams(window.location.search);
        const bizId = params.get('bizId');
        const color = params.get('color') || '#2563eb';
        const agentName = params.get('agentName') || 'Support Chat';
        const welcomeMsg = params.get('welcome') || "Hello! \uD83D\uDC4B We're here to help. Ask us anything about our services.";

        // Styling Updates
        document.getElementById('header').style.backgroundColor = color;
        document.querySelector('button[type="submit"]').style.backgroundColor = color;

        // Dynamic Content
        const headerTitle = document.querySelector('#header h1');
        const headerSub = document.querySelector('#header p');
        headerTitle.textContent = agentName;
        headerSub.innerHTML = '<span class="inline-block w-2 h-2 bg-green-400 rounded-full mr-1"></span> Online';

        const initialMsg = document.querySelector('#chat-messages div > div');
        if (initialMsg) initialMsg.textContent = welcomeMsg;

        const chatContainer = document.getElementById('chat-messages');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('user-input');

        // Session ID storage
        let chatId = localStorage.getItem('contextbot_chat_id');
        let pageContext = null;

        // Listen for context from parent widget.js
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'PAGE_CONTEXT') {
                pageContext = event.data;
                console.log('ContextBot: Received page context', pageContext.title);
            }
        });

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} message-enter`;

            const bubble = document.createElement('div');
            const userClasses = 'bg-blue-600 text-white rounded-2xl rounded-tr-none';
            const botClasses = 'bg-white border text-gray-800 rounded-2xl rounded-tl-none shadow-sm';

            bubble.className = `p-4 max-w-[85%] text-[15px] leading-relaxed ${sender === 'user' ? userClasses : botClasses}`;
            if (sender === 'user') bubble.style.backgroundColor = color;

            bubble.textContent = text;
            div.appendChild(bubble);
            chatContainer.appendChild(div);
            // Smooth scroll
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        async function sendMessage(message) {
            appendMessage(message, 'user');
            input.value = '';
            input.disabled = true;

            // Loading indicator
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex justify-start message-enter';
            loadingDiv.innerHTML = '<div class="bg-gray-100 p-3 rounded-2xl rounded-tl-none text-xs text-gray-500 flex items-center gap-1"><span class="animate-bounce">‚óè</span><span class="animate-bounce delay-100">‚óè</span><span class="animate-bounce delay-200">‚óè</span></div>';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch('http://localhost:3000/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bizId,
                        message,
                        chatId,
                        pageContext // Send captured context
                    })
                });

                const data = await response.json();

                if (data.chatId) {
                    chatId = data.chatId;
                    localStorage.setItem('contextbot_chat_id', chatId);
                }

                document.getElementById(loadingId).remove();
                appendMessage(data.response || 'Sorry, I encounted an error.', 'bot');

            } catch (error) {
                console.error(error);
                document.getElementById(loadingId).remove();
                appendMessage('Error connecting to server.', 'bot');
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if (text && bizId) sendMessage(text);
        });
    </script>
</body>

</html>